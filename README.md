# 图像分析工作流

该项目实现了一个基于 LangGraph、Ollama和PyTorch的图像分析工作流。用户可以提供图像及需求，系统会根据用户的需求自动选择合适的分析任务，并进行图像处理、推理与输出。通过Web界面，用户可以轻松上传图片并获取分析结果。

## 目录

- [项目简介](#项目简介)
- [系统要求](#系统要求)
- [安装依赖](#安装依赖)
- [Ollama模型配置](#Ollama模型配置)
- [工作流程概述](#工作流程概述)
- [Web界面使用方法](#Web界面使用方法)
- [命令行使用方法](#命令行使用方法)
- [常见问题](#常见问题)

## 项目简介

这个图像分析工作流通过 LangGraph 编排了不同的处理步骤，包括图像输入、预处理、模型选择、推理、输出等。每个步骤的处理都包含错误处理机制，确保系统在面对不同输入时能够智能响应。

工作流的主要功能如下：

1. **需求分析**：根据用户输入的需求，使用Ollama中的phi4-mini模型自动判断任务类型。
2. **图像输入**：支持加载用户指定路径的图像，Web界面提供图像预览功能。
3. **图像预处理**：根据任务类型进行相应的预处理。
4. **模型选择**：自动选择适合任务的模型：
   - **分类**：ResNet50（ImageNet预训练模型）
   - **标注**：YOLOv5（物体检测）
   - **描述**：LLaVA-13B（图文理解）
   - **增强**：SwinIR（超分辨率）
5. **推理**：使用选定的模型进行推理，并输出结果。
6. **结果输出**：根据任务类型输出分类结果、注释图像、图像描述或增强图像。
7. **资源释放**：任务完成后自动释放GPU显存和Ollama模型资源。

## 系统要求

- Python 3.9+
- CUDA支持的GPU (推荐用于YOLOv5和SwinIR模型)
- Ollama服务 (用于需求分析和图像描述)
- 至少8GB RAM
- 约10GB磁盘空间 (用于存储模型)

## 安装依赖

首先，确保您的 Python 环境中已安装以下依赖：

```bash
pip install -r requirements.txt
```

## Ollama模型配置

本项目使用Ollama服务来加载和运行LLM模型。请按照以下步骤配置：

1. 安装Ollama：
   访问 [Ollama官网](https://ollama.com/) 下载并安装适合您平台的版本

2. 拉取所需模型：
   ```bash
   # 用于需求分析的小模型
   ollama pull phi4-mini

   # 用于图像描述的多模态模型
   ollama pull llava:13b
   ```

3. 确保Ollama服务在后台运行：
   ```bash
   # 在Windows上，可以通过服务管理器检查Ollama服务是否运行
   # 在Linux/Mac上，可以使用以下命令
   ollama serve
   ```

## 工作流程概述

图像分析工作流由以下几个关键步骤构成：

1. **分析节点（analysis_node）**：使用phi4-mini模型根据用户需求分析任务类型（分类、标注、描述、增强）。
2. **图像输入节点（image_input_node）**：加载用户指定的图像文件。
3. **图像预处理节点（preprocess_node）**：根据任务类型对图像进行预处理。
4. **模型选择节点（model_selection_node）**：选择合适的模型。
5. **推理节点（inference_node）**：执行推理，得到结果。
6. **结果输出节点（output_node）**：根据任务输出相应的结果。
7. **错误处理节点（error_handler_node）**：当发生错误时，进行错误处理并恢复工作流程。
8. **资源清理（cleanup_resources）**：释放GPU显存和模型资源。

## Web界面使用方法

1. **启动Web服务**：
   ```bash
   python app.py
   ```

2. **访问Web界面**：
   打开浏览器访问 `http://127.0.0.1:5000`

3. **使用步骤**：
   - 点击"选择文件"上传图像（支持jpg, jpeg, png格式）
   - 输入分析需求（例如："这是什么"、"描述这张图片"、"标注所有物体"或"提高图像清晰度"）
   - 点击"开始分析"按钮
   - 等待处理完成，查看分析结果

4. **界面特性**：
   - 图像预览功能：选择文件后会显示图像预览
   - 加载动画：处理过程中显示加载动画
   - 结果展示：根据任务类型以不同方式呈现结果

## 命令行使用方法

1. **启动项目**：
   ```bash
   python app.py
   ```
2. **输入需求**：

   用户需提供对图像的描述性需求，例如：
   - **分类**：识别图像中的主要对象或类别（例如："这是什么动物？"）。
   - **标注**：检测并定位图像中的多个对象（例如："找出所有物体及其位置"）。
   - **描述**：提供图像的详细描述（例如："描述图像中发生的事情"）。
   - **增强**：提高图像质量或分辨率（例如："提高图像清晰度"）。

   示例：
   ```text
   请输入您的图像分析需求：找出所有物体及其位置
   ```

3. **处理与输出**：

   根据输入需求，系统会自动完成图像的分析、处理和输出，并显示最终结果。

## 常见问题

1. **无法读取图像**：
   确保提供的图像路径正确，且图像文件格式支持（如 .jpg、.png）。

2. **任务无法识别**：
   如果用户输入的需求无法被分析模型识别为有效任务，系统会智能判断或使用默认任务（图像描述）。

3. **模型加载错误**：
   - 确保Ollama服务正在运行，且已下载所需模型。
   - 对于CUDA错误，系统会尝试回退到CPU模式。

4. **内存或显存不足**：
   - 系统在每个任务完成后会自动释放资源。
   - 如仍遇到内存问题，可以重启应用或使用更小的模型。

5. **图像增强慢**：
   图像增强任务（特别是使用SwinIR模型）计算密集，在CPU上可能较慢，推荐使用GPU。
